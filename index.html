<!DOCTYPE html>
<meta charset="utf-8">
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-132451521-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-132451521-5');
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/css/bootstrap.css">

<link href="https://fonts.googleapis.com/css2?family=Exo:wght@700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Exo:wght@300&display=swap" rel="stylesheet">

<style>


.svg-container {
    display: inline-block;
    position: relative;
    width: 90%;
    padding-bottom: 100%; /* aspect ratio */
    vertical-align: top;
}
.svg-content-responsive {
    display: inline-block;
    position: absolute;
    top: 10px;
    left: 0;
}

body {
  background: #222; /* Old browsers */
  font-family: 'Exo', sans-serif;
  text-align: center;
  font-weight: 700;
  color: #999;
}
.navigationBar, .navbar-light, .bg-light{
  background-color: #999 !important;
  color: #222;
}

.intro {
  margin: 5em 0 0 0;
  padding: .2em inherit;
}

.intro img {
  max-width: 6em;
  margin: .75em 0 .75em 0;
  height: auto;
  border: .1em solid #212830;
  border-radius: 50%;
}

.yaxis {
  stroke: #999;
  fill: #999;
  font-weight: 300;
  font-size: 1.2em;
}

.key {
  margin: 0;
  padding: 0;
  color:#222;
}



/* Small devices (landscape phones, less than 768px)*/
@media (max-width: 767.98px) {

  .intro h5 {
    padding: 1.35em 0 0 0;
  }
}

/* Medium devices (tablets, less than 992px)*/
@media (max-width: 991.98px) {

  .intro h5 {
    padding: 1.35em 0 0 0;
  }
}

.nohover {
  pointer-events: none;
}

</style>
<body>
<script src="https://d3js.org/d3.v3.js"></script>

  <div class="navigationBar fixed-top">
    <div class="container">
      <nav class="navbar navbar-expand navbar-light bg-light">
        <a class="navbar-brand" href="#">will.stedden</a>
        <ul class="nav navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="https://bonkerfield.org">projects</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="https://viewfoil.bonkerfield.org">contact</a>
          </li>

        </ul>
      </nav>
    </div>
  </div>
<!--Responsive Introduction contained here -->
  <header class="intro" id="intro-link">
    <div class="container">
      <div class="row text-center">
           <div class="col-lg-2 col-md-12 col-sm-12 col-xs-12 order-1">
            <img class="img-fluid mx-auto d-block" height="10px;" src="/face_prof.jpg" alt="">
          </div>
          <div class="col-lg-10 col-md-12 col-sm-12 col-xs-12 order-2 align-self-center">
          <h5>Working on lots of things in parallel. Currently <a href="https://anthem.ai">machine learning in healthcare</a>, <a href="https://bonkerfield.org/2020/02/combining-gpt-2-and-bert/">automated language generation</a>, <a href="https://bonkerfield.org/2020/04/qmb-burning-man-honorarium/">quantum physics art</a>, <a href="https://bonkerfield.org/2020/04/getting-so-so-social/">indieweb dev</a>, and <a href="https://viewfoil.bonkerfield.org/">online transparency</a>.</h5>

        </div>
      </div>
    </div>
</header>

<div class="chart" id="chart">
</div>

<script>

chart();

// window.addEventListener("resize", chart);


function chart() {

  var format = d3.time.format("%m/%d/%y");

  var margin = {top: 20, right: 40, bottom: 30, left: 30};

  var width = document.body.clientWidth - margin.left - margin.right;

  var height = 5000 - margin.top - margin.bottom;

  var tooltip = d3.select(".chart")
      .append("div")
      .attr("class", "remove")
      .style("position", "absolute")
      .style("z-index", "20")
      .style("visibility", "hidden");

  var x = d3.scale.linear()
      .range([0, width]);

  var y = d3.time.scale()
      .range([height-10, 0]);

  var yAxis = d3.svg.axis()
      .scale(y);

  var stack = d3.layout.stack()
      .offset("silhouette")
      .values(function(d) { return d.values; })
      .x(function(d) { return d.date; })
      .y(function(d) { return d.value; });

  var nest = d3.nest()
      .key(function(d) { return d.project; });

  var area = d3.svg.area()
      .interpolate("basis")
      .y(function(d) { return y(d.date); })
      .x0(function(d) { return x(d.y0); })
      .x1(function(d) { return x(d.y0 + d.y); });

  var svg = d3.select(".chart").append("div")
      .classed("svg-container", true) //container class to make it responsive
      .append("svg")
      .attr("preserveAspectRatio", "xMinYMin meet")
      .attr("viewBox", "0 0 "+width+" " +height)
      .classed("svg-content-responsive", true)
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  var url_data = "https://spreadsheets.google.com/feeds/list/1WmkDCeImSR7k5JnNn7HE4ZiDH3j4X-iIarkBrbbPvQ8/1/public/values?alt=json"

  var url_metadata = "https://spreadsheets.google.com/feeds/list/1WmkDCeImSR7k5JnNn7HE4ZiDH3j4X-iIarkBrbbPvQ8/2/public/values?alt=json"

  d3.json(url_metadata, function (meta_result) {
    var metadata = {};
    for (var i = 0; i < meta_result.feed.entry.length; i += 1) {
        proj = meta_result.feed.entry[i].gsx$project.$t
        metadata[proj] = {
            "color": meta_result.feed.entry[i].gsx$color.$t,
            "link": meta_result.feed.entry[i].gsx$link.$t,
            "order": meta_result.feed.entry[i].gsx$order.$t,
            "description": meta_result.feed.entry[i].gsx$description.$t
        }
    }

    d3.json(url_data, function (result) {
      var data = [];
      all_dates = {};
      unique_projects = {};
      for (var i = 0; i < result.feed.entry.length; i += 1) {
          date_val = result.feed.entry[i].gsx$date.$t;
          project_val = result.feed.entry[i].gsx$project.$t;
          data.push({
              "date": date_val,
              "value": result.feed.entry[i].gsx$value.$t,
              "project": project_val
          });
          if (!(date_val in all_dates)){
            all_dates[date_val] = true;
          }
          if (!(project_val in unique_projects)){
            unique_projects[project_val] = {};
          }
          unique_projects[project_val][date_val]=true;
      }

      for (p in unique_projects){
        for (dt in all_dates) {
          if (!(dt in unique_projects[p])){
            data.push({
              "date": dt,
              "value": 0,
              "project": p
            });
          }
        }
      }


      data.forEach(function(d) {
        d.date = format.parse(d.date);
        d.value = +d.value;
        if (d.project in metadata){
          d.color = metadata[d.project]['color']
          d.link = metadata[d.project]['link']
          d.order = metadata[d.project]['order']
          d.description = metadata[d.project]['description']
        } else {
          d.color = '#111111'
          d.link = '#'
          d.order = 1
          d.description = ''
        }
      });

      function compare( a, b ) {
        if ( b.order > a.order ){
          return -1;
        }
        if ( a.order > b.order ){
          return 1;
        }
        if ( b.date > a.date ){
          return -1;
        }
        if ( a.date > b.date ){
          return 1;
        }
        return 0;
      }

      data.sort(compare);

      var layers = stack(nest.entries(data));
      console.log((layers[0].values))

      y.domain(d3.extent(data, function(d) { return d.date; }));
      x.domain([0, 1.05*d3.max(data, function(d) { return d.y0 + d.y; })]);

      svg.selectAll(".layer")
          .data(layers)
        .enter().append("a")
          .attr("xlink:href", function(d) { return d.values[0].link; })
          .append("path")
          .attr("class", "layer")
          .attr("opacity", 0.8)
          .attr("d", function(d) { return area(d.values); })
          .style("fill", function(d) { return d.values[0].color; });

      svg.selectAll(".layer").transition()
        .duration(1)
        .attr("opacity", 0.8);

      prefer_x_width = 100
      min_x_width = 50
      x_width_step = 5

      function transform_func(d){
        txt_len = d.values[0].project.length
        for (width_cutoff = prefer_x_width; width_cutoff > min_x_width; width_cutoff-=x_width_step){
          min_y = 100000
          min_xl = 0
          min_xr = 0
          for (i=0; i < d.values.length; i++){
            y_val = y(d.values[i].date)
            xl_val = x(d.values[i].y0)
            xr_val = x(d.values[i].y0+d.values[i].y)
            if ((xr_val-xl_val)>width_cutoff && y_val < min_y ){
              min_y = y_val
              min_xl = xl_val
              min_xr = xr_val
            }
          }
          min_x = (min_xl + min_xr)/2.
          if (min_x >= width_cutoff) {
            scale = (min_xr-min_xl)/Math.sqrt(txt_len)/50
            return "translate("+min_x+","+(min_y-10)+") scale("+scale+") translate(-"+(3*txt_len)+",30)"
          }
        }
      }
      function visible_func(d){
        min_y = 100000
        min_xl = 0
        min_xr = 0
        txt_len = d.values[0].project.length
        for (i=0; i < d.values.length; i++){
          y_val = y(d.values[i].date)
          xl_val = x(d.values[i].y0)
          xr_val = x(d.values[i].y0+d.values[i].y)
          if ((xr_val-xl_val)>min_x_width && y_val < min_y ){
            min_y = y_val
            min_xl = xl_val
            min_xr = xr_val
          }
        }
        return (min_xr-min_xl) < min_x_width+x_width_step ? 'hidden' : 'visible'
      }
      svg.selectAll("text")
          .data(layers)
        .enter().append("text")
        .attr('class','nohover')
        .attr("fill", '#333')
        .attr("visibility", visible_func)
        .attr("transform", transform_func)
        .text((d) => d.values[0].project);

      max_date = d3.max(data, function(d) { return d.date; });
      min_date = d3.min(data, function(d) { return d.date; });
      var dateArray = d3.time.scale()
                .domain([new Date(min_date.getFullYear(), 12, 1), new Date(max_date.getFullYear()-1, 12, 1)])
                .ticks(d3.time.years, 1);
      dateArray.push(max_date)
      const monthNames = ["January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ];
      yAxis = yAxis.tickValues(dateArray)
        .tickFormat(d => ('<- ' + ((d==max_date) ? (monthNames[d.getMonth()]+', '+d.getFullYear()) : d.getFullYear()-1)));

      svg.append("g")
          .attr("class", "yaxis")
          .call(yAxis.orient("left"))
          .selectAll("text")
            .style("text-anchor", "end")
            .style("color", "#999")
            .attr("dx", ".4em")
            .attr("dy", "-.6em")
            .attr("transform", "rotate(-90)" );

      svg.selectAll(".layer")
        .on("mouseover", function(d, i) {
          svg.selectAll(".layer").transition()
            .duration(100)
            .attr("opacity", function(d, j) {
              return j != i ? 0.8 : 1;
        })})
        .on("mousemove", function(d, i) {

          mouse = d3.mouse(document.body);
          mousex = mouse[0];
          mousey = mouse[1];
          f = d.values[0]
          var date = f.date
          txt_width = f.description.length
          tooltip
            .style("left", (mousex-txt_width*4) +"px")
            .style("top", (mousey+100) +"px")
            .html("<div class='key'>" + f.project + "</div><div class='desc'>"+f.description+"</div>")
            .style("visibility", "visible");
        })
        .on("mouseout", function(d, i) {
          svg.selectAll(".layer").transition()
            .duration(100)
            .attr("opacity", 0.8);
          tooltip.style("visibility", "hidden");
        });

        var gradient = svg.append("defs")
          .append("linearGradient")
          .attr("id", "gradient")
          .attr("x1", "100%")
          .attr("y1", "100%")
          .attr("x2", "100%")
          .attr("y2", "0%")
          .attr("spreadMethod", "pad");

        gradient.append("stop")
          .attr("offset", "0%")
          .attr("stop-color", "#000")
          .attr("stop-opacity", 1);

        gradient.append("stop")
          .attr("offset", "100%")
          .attr("stop-color", "#000")
          .attr("stop-opacity", 0);

        svg.append("rect")
          .attr('class','nohover')
          .attr("width", 2*width)
          .attr("height", height/3)
          .attr("x", -width/2)
          .attr("y", 2*height/3)
          .style("fill", "url(#gradient)");
    });

  });
}
</script>